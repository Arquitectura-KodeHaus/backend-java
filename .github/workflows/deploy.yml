name: Build → Staging → (Approval) → Prod | backend-java

on:
  push:
    branches: ["prod"]          # push a prod
  pull_request:
    branches: ["prod"]          # PR hacia prod: solo llega a staging
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-backend-java
  cancel-in-progress: false

# -----------------------------
# 1) Build & Push (STAGING)
# -----------------------------
jobs:
  build_push_staging:
    name: Build & Push (staging)
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t local/backend-java:${{ github.sha }} .

      - name: Auth to Google Cloud (STAGING via OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account:         ${{ vars.DEPLOY_SA }}
          project_id:              ${{ vars.GCP_PROJECT_ID }}
          export_environment_variables: true

      - name: Setup gcloud (STAGING)
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry (STAGING)
        run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Tag & Push (STAGING)
        run: |
          STG_IMG="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/backend-java"
          docker tag local/backend-java:${{ github.sha }} "$STG_IMG:${{ github.sha }}"
          docker tag local/backend-java:${{ github.sha }} "$STG_IMG:staging"
          docker push "$STG_IMG:${{ github.sha }}"
          docker push "$STG_IMG:staging"

# -----------------------------
# 2) Build & Push (PROD) - solo en push
# -----------------------------
  build_push_prod:
    name: Build & Push (prod)
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: production
    needs: [build_push_staging]
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t local/backend-java:${{ github.sha }} .

      - name: Auth to Google Cloud (PROD via OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}         # secreto del env production
          service_account:         ${{ vars.DEPLOY_SA_PROD }}
          project_id:              ${{ vars.GCP_PROJECT_ID_PROD }}
          export_environment_variables: true

      - name: Setup gcloud (PROD)
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID_PROD }}

      - name: Configure Docker for Artifact Registry (PROD)
        run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Tag & Push (PROD)
        run: |
          PROD_IMG="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID_PROD }}/${{ vars.ARTIFACT_REPO }}/backend-java"
          docker tag local/backend-java:${{ github.sha }} "$PROD_IMG:${{ github.sha }}"
          docker tag local/backend-java:${{ github.sha }} "$PROD_IMG:latest"
          docker push "$PROD_IMG:${{ github.sha }}"
          docker push "$PROD_IMG:latest"

# -----------------------------
# 3) Deploy STAGING
# -----------------------------
  deploy_staging:
    name: Deploy STAGING
    runs-on: ubuntu-latest
    environment: staging
    needs: [build_push_staging]
    steps:
      - name: Auth to Google Cloud (STAGING via OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account:         ${{ vars.DEPLOY_SA }}
          project_id:              ${{ vars.GCP_PROJECT_ID }}

      - name: Deploy Cloud Run (staging)
        id: deploy_stg
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ vars.SERVICE_STAGING }}
          image: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/backend-java:${{ github.sha }}
          region: ${{ vars.GCP_REGION }}
          flags: >
            --allow-unauthenticated
            --service-account=${{ vars.RUNTIME_SA }}
            --set-env-vars=GOOGLE_CLOUD_PROJECT=${{ vars.GCP_PROJECT_ID }}

      - name: Smoke test (staging)
        shell: bash
        run: |
          URL="${{ steps.deploy_stg.outputs.url }}"
          echo "Staging URL: $URL"
          code=$(curl -s -o /dev/null -w '%{http_code}' "$URL/healthz" || true)
          [[ "$code" == "200" ]] || { echo "Smoke test falló ($code)"; exit 1; }
          echo "Staging OK: $URL" >> "$GITHUB_STEP_SUMMARY"

# -----------------------------
# 4) Deploy PROD (requiere aprobación del env)
# -----------------------------
  deploy_production:
    name: Deploy PRODUCTION (QA approval)
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: production     # aquí aplica el gate de QA
    needs: [deploy_staging, build_push_prod]
    steps:
      - name: Auth to Google Cloud (PROD via OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account:         ${{ vars.DEPLOY_SA_PROD }}
          project_id:              ${{ vars.GCP_PROJECT_ID_PROD }}

      - name: Deploy Cloud Run (prod)
        id: deploy_prod
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ vars.SERVICE_PROD }}
          image: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID_PROD }}/${{ vars.ARTIFACT_REPO }}/backend-java:${{ github.sha }}
          region: ${{ vars.GCP_REGION }}
          flags: >
            --allow-unauthenticated
            --service-account=${{ vars.RUNTIME_SA_PROD }}
            --set-env-vars=GOOGLE_CLOUD_PROJECT=${{ vars.GCP_PROJECT_ID_PROD }}

      - name: Publica URL PROD
        shell: bash
        run: |
          echo "PROD URL: ${{ steps.deploy_prod.outputs.url }}" >> "$GITHUB_STEP_SUMMARY"
